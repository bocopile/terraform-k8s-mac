---
# Alertmanager ConfigMap
# ëª©ì : ì•Œë¦¼ ë¼ìš°íŒ… ë° ìˆ˜ì‹ ì ì„¤ì •
apiVersion: v1
kind: ConfigMap
metadata:
  name: alertmanager-config
  namespace: signoz
  labels:
    app: alertmanager
    managed-by: terraform
data:
  alertmanager.yml: |
    # ì „ì—­ ì„¤ì •
    global:
      resolve_timeout: 5m
      # Slack Webhook URL (í™˜ê²½ë³€ìˆ˜ë¡œ ì£¼ì…)
      slack_api_url: '{{ .SlackWebhookURL }}'

    # í…œí”Œë¦¿
    templates:
      - '/etc/alertmanager/templates/*.tmpl'

    # ë¼ìš°íŒ… íŠ¸ë¦¬
    route:
      # ê¸°ë³¸ ìˆ˜ì‹ ì
      receiver: 'default'

      # ê·¸ë£¹í™” ê¸°ì¤€ (ë™ì¼í•œ ì•Œë¦¼ì„ ë¬¶ìŒ)
      group_by: ['alertname', 'cluster', 'namespace', 'severity']

      # ê·¸ë£¹ ëŒ€ê¸° ì‹œê°„ (ì²« ì•Œë¦¼ ë°œìƒ í›„ ëŒ€ê¸°)
      group_wait: 30s

      # ê·¸ë£¹ ê°„ê²© (ë™ì¼ ê·¸ë£¹ì˜ ì—°ì† ì•Œë¦¼ ê°„ê²©)
      group_interval: 5m

      # ë°˜ë³µ ê°„ê²© (í•´ê²°ë˜ì§€ ì•Šì€ ì•Œë¦¼ ì¬ì „ì†¡)
      repeat_interval: 4h

      # í•˜ìœ„ ë¼ìš°íŠ¸
      routes:
        # Critical ì•Œë¦¼ â†’ Slack + Email
        - match:
            severity: critical
          receiver: 'critical-alerts'
          group_wait: 10s
          group_interval: 1m
          repeat_interval: 1h

        # Warning ì•Œë¦¼ â†’ Slack
        - match:
            severity: warning
          receiver: 'warning-alerts'
          group_interval: 5m
          repeat_interval: 4h

        # ì¸í”„ë¼ ì•Œë¦¼ (Node, Disk)
        - match_re:
            alertname: ^(NodeDown|DiskSpaceWarning|DiskSpaceCritical|HighCPUUsage|HighMemoryUsage)$
          receiver: 'infra-alerts'
          group_wait: 30s
          group_interval: 5m

        # ì• í”Œë¦¬ì¼€ì´ì…˜ ì•Œë¦¼
        - match_re:
            alertname: ^(HighErrorRate|HighLatency|PodCrashLooping|DeploymentReplicasMismatch)$
          receiver: 'app-alerts'
          group_interval: 5m

        # ë°ì´í„°ë² ì´ìŠ¤ ì•Œë¦¼
        - match_re:
            alertname: ^(DatabaseDown|SlowQueries|ConnectionPoolExhausted)$
          receiver: 'database-alerts'
          group_interval: 5m

    # ì–µì œ ê·œì¹™ (ìƒìœ„ ì•Œë¦¼ ë°œìƒ ì‹œ í•˜ìœ„ ì•Œë¦¼ ì–µì œ)
    inhibit_rules:
      # Critical ë°œìƒ ì‹œ Warning ì–µì œ
      - source_match:
          severity: 'critical'
        target_match:
          severity: 'warning'
        equal: ['alertname', 'namespace', 'pod']

      # Node Down ì‹œ Pod ì•Œë¦¼ ì–µì œ
      - source_match:
          alertname: 'NodeDown'
        target_match_re:
          alertname: '^(PodCrashLooping|PodNotReady)$'
        equal: ['node']

    # ìˆ˜ì‹ ì ì„¤ì •
    receivers:
      # ê¸°ë³¸ ìˆ˜ì‹ ì (í…ŒìŠ¤íŠ¸ìš©)
      - name: 'default'
        webhook_configs:
          - url: 'http://localhost:5001/webhook'
            send_resolved: true

      # Critical ì•Œë¦¼ â†’ Slack + Email
      - name: 'critical-alerts'
        slack_configs:
          - channel: '#alerts-critical'
            title: 'ğŸš¨ CRITICAL: {{ .GroupLabels.alertname }}'
            text: |
              *Summary:* {{ .CommonAnnotations.summary }}
              *Description:* {{ .CommonAnnotations.description }}
              *Severity:* {{ .CommonLabels.severity }}
              *Namespace:* {{ .CommonLabels.namespace }}
              *Pod:* {{ .CommonLabels.pod }}
            send_resolved: true
            actions:
              - type: button
                text: 'View in SigNoz'
                url: 'http://signoz.local:3301/alerts'

      # Warning ì•Œë¦¼ â†’ Slack
      - name: 'warning-alerts'
        slack_configs:
          - channel: '#alerts-warning'
            title: 'âš ï¸ WARNING: {{ .GroupLabels.alertname }}'
            text: |
              *Summary:* {{ .CommonAnnotations.summary }}
              *Namespace:* {{ .CommonLabels.namespace }}
            send_resolved: true

      # ì¸í”„ë¼ ì•Œë¦¼ â†’ Slack (ì¸í”„ë¼ ì „ìš© ì±„ë„)
      - name: 'infra-alerts'
        slack_configs:
          - channel: '#alerts-infra'
            title: 'ğŸ–¥ï¸ INFRA: {{ .GroupLabels.alertname }}'
            text: |
              *Summary:* {{ .CommonAnnotations.summary }}
              *Node:* {{ .CommonLabels.node }}
              *Instance:* {{ .CommonLabels.instance }}
            send_resolved: true

      # ì• í”Œë¦¬ì¼€ì´ì…˜ ì•Œë¦¼ â†’ Slack (ì•± ì „ìš© ì±„ë„)
      - name: 'app-alerts'
        slack_configs:
          - channel: '#alerts-app'
            title: 'ğŸ“± APP: {{ .GroupLabels.alertname }}'
            text: |
              *Summary:* {{ .CommonAnnotations.summary }}
              *Namespace:* {{ .CommonLabels.namespace }}
              *Pod:* {{ .CommonLabels.pod }}
            send_resolved: true

      # ë°ì´í„°ë² ì´ìŠ¤ ì•Œë¦¼ â†’ Slack (DB ì „ìš© ì±„ë„)
      - name: 'database-alerts'
        slack_configs:
          - channel: '#alerts-database'
            title: 'ğŸ’¾ DATABASE: {{ .GroupLabels.alertname }}'
            text: |
              *Summary:* {{ .CommonAnnotations.summary }}
              *Database:* {{ .CommonLabels.database }}
              *Namespace:* {{ .CommonLabels.namespace }}
            send_resolved: true
