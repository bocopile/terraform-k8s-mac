# Fluent Bit for App Cluster
# Lightweight log forwarder to Control Cluster Loki

image:
  repository: fluent/fluent-bit
  tag: 2.1.8

# DaemonSet - runs on every node
kind: DaemonSet

# Resources (lightweight)
resources:
  requests:
    cpu: 100m
    memory: 128Mi
  limits:
    cpu: 500m
    memory: 256Mi

# Service
service:
  type: ClusterIP

# Configuration
config:
  # Input: Kubernetes container logs
  inputs: |
    [INPUT]
        Name              tail
        Path              /var/log/containers/*.log
        multiline.parser  docker, cri
        Tag               kube.*
        Mem_Buf_Limit     5MB
        Skip_Long_Lines   On

    [INPUT]
        Name              systemd
        Tag               host.*
        Systemd_Filter    _SYSTEMD_UNIT=kubelet.service
        Read_From_Tail    On

  # Filters: Parse and enrich logs
  filters: |
    [FILTER]
        Name                kubernetes
        Match               kube.*
        Kube_URL            https://kubernetes.default.svc:443
        Kube_CA_File        /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
        Kube_Token_File     /var/run/secrets/kubernetes.io/serviceaccount/token
        Kube_Tag_Prefix     kube.var.log.containers.
        Merge_Log           On
        Keep_Log            Off
        K8S-Logging.Parser  On
        K8S-Logging.Exclude On
        Labels              On
        Annotations         Off

    [FILTER]
        Name                nest
        Match               kube.*
        Operation           lift
        Nested_under        kubernetes
        Add_prefix          kubernetes_

    [FILTER]
        Name                modify
        Match               kube.*
        Add                 cluster app-cluster
        Add                 environment production

    [FILTER]
        Name                nest
        Match               kube.*
        Operation           nest
        Wildcard            kubernetes_*
        Nest_under          kubernetes
        Remove_prefix       kubernetes_

  # Output: Forward to Loki on Control Cluster
  outputs: |
    [OUTPUT]
        Name                loki
        Match               *
        Host                192.168.64.104
        Port                3100
        Labels              job=fluent-bit, cluster=app-cluster
        Label_keys          $kubernetes['namespace_name'],$kubernetes['pod_name'],$kubernetes['container_name']
        Line_format         json
        Auto_kubernetes_labels On

    # Debug output (optional)
    # [OUTPUT]
    #     Name                stdout
    #     Match               *
    #     Format              json_lines

# Volume mounts
volumeMounts:
  - name: varlog
    mountPath: /var/log
    readOnly: true
  - name: varlibdockercontainers
    mountPath: /var/lib/docker/containers
    readOnly: true

daemonSetVolumes:
  - name: varlog
    hostPath:
      path: /var/log
  - name: varlibdockercontainers
    hostPath:
      path: /var/lib/docker/containers

# Service Account
serviceAccount:
  create: true
  annotations: {}

# RBAC
rbac:
  create: true
  nodeAccess: true

# Pod Security
podSecurityPolicy:
  create: false

# Tolerations (run on all nodes including masters)
tolerations:
  - key: node-role.kubernetes.io/master
    operator: Exists
    effect: NoSchedule
  - key: node-role.kubernetes.io/control-plane
    operator: Exists
    effect: NoSchedule

# Node Selector (optional)
nodeSelector: {}

# Affinity (optional)
affinity: {}
